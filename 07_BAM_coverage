## NOTE, after duplicate removal, we now compute the sequencing depth per sample.
## The code calculates 10 kb windowed coverage for a BAM file, using 1 thread, excluding low-quality/secondary/supplementary reads, outputting only summary and region coverage files.
## For this, we use the "nodupl_name.list" created in step 06_Add_Read_Groups.
## We also need to create the subfolders "coverage" under /scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/05.BAM/stats. Then we calculate the depth.


#!/bin/bash -l
#SBATCH -J mosdepth
#SBATCH -o /scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/05.BAM/logs/mosdepth_%j.out
#SBATCH -e /scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/05.BAM/logs/mosdepth_%j.err
#SBATCH --account=project_2009316
#SBATCH -t 04:00:00
#SBATCH -p small
#SBATCH --array=1-18
#SBATCH --ntasks 1
#SBATCH --mem-per-cpu=4GB
#SBATCH --mail-type=BEGIN,END,FAIL

#Note, we need to export the path here, so that mosdepth is loaded
export PATH="/projappl/project_2009316/myenv/bin:$PATH"

FINALDIR=/scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/05.BAM/nodupl_RG

cd /scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/05.BAM/nodupl

# Get file
file=$(sed -n "$SLURM_ARRAY_TASK_ID"p nodupl_name.list)

# Get sample ID
sample=${file%_nodupl*}

mosdepth -t 1 -b 10000 -n -x ../stats/coverage/$sample $FINALDIR/$sample"_nodupl_wRG.bam"
mosdepth -t 1 -b 10000 -n ../stats/coverage/${sample}_overlap_correction $FINALDIR/$sample"_nodupl_wRG.bam"

### END


### Get coverage for overlap corrected data  --------------------

cd /scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/05.BAM/stats/coverage
rm -rf *global*

for i in *overlap_correction.mosdepth.summary.txt; do echo $i; grep 'Scaffold' "$i" | awk '{sum+=$4} END{print sum/NR}'; done > all.overlap_correction.mosdepth.summary.tmp

grep -v 'txt' all.overlap_correction.mosdepth.summary.tmp > tmp1
grep 'txt' all.overlap_correction.mosdepth.summary.tmp | perl -npe 's/_overlap_correction.mosdepth.summary.txt//' > tmp2
paste tmp2 tmp1 > all.overlap_correction.mosdepth.summary.txt ; rm *tmp*

## This makes the right computation (excludes scaffs 00 & 03), although it doesn't take into account the different chr lengths which is perhaps now ok

for i in *overlap_correction.mosdepth.summary.txt
 do echo $i ; grep 'Scaffold' $i | grep -v 'region' | grep -v 'Scaffold03' | grep -v 'Scaffold00' | awk '{sum+=$4;} END{print sum/NR;}'
done > all.overlap_correction_no0003.mosdepth.summary.tmp

grep -v 'txt' all.overlap_correction_no0003.mosdepth.summary.tmp > tmp1
grep 'txt' all.overlap_correction_no0003.mosdepth.summary.tmp | perl -npe 's/_overlap_correction_no0003.mosdepth.summary.txt//' > tmp2
paste tmp2 tmp1 > all.overlap_correction_no0003.mosdepth.summary.txt ; rm *tmp*

## Do:wnload to local maching
#scp krapfpat@puhti.csc.fi:/scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/05.BAM/stats/coverage/all.overlap_correction_no0003.mosdepth.summary.txt .


### Get coverage for *NON* overlap corrected data  --------------------

for i in $(ls *.mosdepth.summary.txt | grep -v overlap_correction); do
  echo $i
  grep 'Scaffold' "$i" | awk '{sum+=$4} END{print sum/NR}'
done > all.no_overlap_correction.mosdepth.summary.tmp

grep -v 'txt' all.no_overlap_correction.mosdepth.summary.tmp > tmp1
grep 'txt' all.no_overlap_correction.mosdepth.summary.tmp | perl -npe 's/.mosdepth.summary.txt//' > tmp2
paste tmp2 tmp1 > all.no_overlap_correction.mosdepth.summary.txt
rm *tmp*


## Not needed to use this as this was a sample in Ina's data set
#for i in RN???.mosdepth.summary.txt
# do echo $i ; grep 'Scaffold' $i | awk '{sum+=$4;} END{print sum/NR;}'
#done > all.no_overlap_correction.mosdepth.summary.tmp

#grep -v 'txt' all.no_overlap_correction.mosdepth.summary.tmp > tmp1
#grep 'txt' all.no_overlap_correction.mosdepth.summary.tmp | perl -npe 's/.mosdepth.summary.txt//' > tmp2
#paste tmp2 tmp1 > all.no_overlap_correction.mosdepth.summary.txt ; rm *tmp*

## Download to local machine
#scp krapfpat@puhti.csc.fi:/scratch/project_2009316/Adriana/X204SC23115958-Z01-F001_01/05.BAM/stats/coverage/all.no_overlap_correction.mosdepth.summary.txt .


### MODIFY THIS WHEN DECIDING WHICH SAMPLES TO KEEP (ESP #217 MEAN COV=2.16 IS LOW ###
# in R
# options(stringsAsFactors=F)
# tt = read.table("all.overlap_correction.mosdepth.summary.txt", h = F)
# summary(tt$V2)
# overall mean: XXX (XX - XX)
