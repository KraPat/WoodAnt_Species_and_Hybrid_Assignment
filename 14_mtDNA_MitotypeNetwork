# Below, we will first call SNPs from the mitochonrial part of the WGS only
# For this, we nwill use again freebayes and need a "regions_mtDNA.txt" file with only the mtDNA region in it for the SNP calling
# We will use sinteractive to create this regions_mtDNA file

### START sinteractive
sinteractive --account project_2009316 --mem 2000

#modify regions file so that Freebayes accepts it
cd /scratch/project_2009316/refGenome
awk 'BEGIN{OFS=""} {print $1,":",$2,"-",$3}' Formica_hybrid_v1_wFhyb_Sapis_5e6_data_regions.fa.fai > Formica_hybrid_v1_5e6_data_regions.tmp

#remove regions that require different SNP calling parameters if they are needed: Wolbachia (wFhyb*), and Spiroplasma (Spiroplasma*), as well as Scaffold00, but KEEP mtDNA
#that has unmapped reads (for cutting off SNP calling time since it will not be used anyway in the analyses I can think of)
grep -v -e wFhyb -e Spiroplasma -e Scaffold00 Formica_hybrid_v1_5e6_data_regions.tmp > Formica_hybrid_v1_5e6_data_regions_wmtDNA.txt ; rm Formica_hybrid_v1_5e6_data_regions.tmp
grep -e mtDNA Formica_hybrid_v1_5e6_data_regions_wmtDNA.txt > regions_mtDNA.txt
exit sinteractive

### END sinteracive

##### Call SNPs #####
# Now, we create a new folder called "07.VCF_mtDNA"
cd /scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/
mkdir 07.VCF_mtDNA

#Next, we will do the SNP calling. Again, we will use "screen" to create an external screen
screen -S snpcall_mtDNA
module load freebayes # version used in 2023: v1.3.6

cd /scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/06.VCF
REF=/scratch/project_2009316/refGenome
RES=/scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/07.VCF_mtDNA
BAM=/scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/05.BAM/bam_final

freebayes-puhti -time 72 -mem 64 -regions $REF/regions_mtDNA.txt -f $REF/Formica_hybrid_v1_wFhyb_Sapis.fa -L $BAM/all.bam.list -k --genotype-qualities --skip-coverage 15200 --limit-coverage 100 --use-best-n-alleles 3 --pooled-continuous -out $RES/all_samples_mtDNA_raw.vcf
bcftools stats $RES/all_samples_mtDNA_raw.vcf
#161 SNPs with 38 samples
#Since there are only 161 SNPs, we do not any additional filtering, but only sorting and compressing the VCF file in the next steps below

####### SORTING, COMPRESSING, AND INDEXING #####
#Now, we sort and compress the VCF file using sineractive
sinteractive --account project_2009316 --mem 2000
module load biokit
cd /scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/07.VCF_mtDNA

# In the next step we "Sort" and "compress" the VCF file in one step.
bcftools sort -m 1G -Oz -o all_samples_mtDNA_raw.vcf.gz -T ./tmp_sort all_samples_mtDNA_raw.vcf

# Index
tabix -p vcf all_samples_mtDNA_raw.vcf.gz
bcftools index -n all_samples_mtDNA_raw.vcf.gz

#Extract the number of sites per mtDNA 
gunzip -c all_samples_mtDNA_raw.vcf.gz | grep -v "^#" | cut -f 1 | uniq -c > site_count_per_mtDNA.tab
#185


######### Create file for PopArt #########
## Next, we create a consensus sequence by by applying VCF variants to a reference fasta file using vcftools vcf-consensus scripts from
## https://github.com/vcftools/vcftools/blob/master/src/perl/vcf-consensus#L111
#Note, this is a pearl script. You have to copy-paste it to a file "vcf-consensus_code.pl" and make it executable with
chmod +x cf_consensus.pl

#Now, we create a sample list using 
bcftools query -l all_samples_mtDNA_raw.vcf.gz > samples.list

#Then you can use it. I now created a forward loop, which iterates through the samples.list file and creates the consensu file. For this, you forst run sinteractive

#while IFS= read -r samples; do
#        echo $samples
#        samtools faidx /scratch/project_2009316/refGenome/Formica_hybrid_v1_wFhyb_Sapis.fa mtDNA | ./vcf_consensus.pl -H 1 -s $samples Samples257_DP8.257inds.AN10.mtDNA.mac2.vcf.gz > $samples"_mtDNA".fa
#done < samples.list
#NOTE. -H keeps the first haplotype, -s are the samples

#In one line:
while IFS= read -r s; do samtools faidx /scratch/project_2009316/refGenome/Formica_hybrid_v1_wFhyb_Sapis.fa mtDNA | ./vcf_consensus.pl -H 1 -s "$s" all_samples_mtDNA_raw.vcf.gz > "${s}_mtDNA.fa"; done < samples.list

###
#After this, you will fa.files for each sample. Move these files into a folder "mtDNA_fa", which you will create using mkdir
mkdir mtDNA_fa
mv *fa mtDNA_fa/

#Inside the folder, we now add all fa-files into a sample list
ls *fa > list.samples

#Each fa.file starts with ">mtDNA", but we want to have them all stored in one fasta-file with the sample ID.
# To do this, we create a new script, "mafft.sh". This script, first, re-names the first line in each fasta file with the sample ID (e.g. from >mtDNA to >1-Fprat).
#Second, it cats all fasta-files into one file (all38_mtDNAsamples.fa).
#Third, it aligns the files using mafft with the output: all38_mtDNAsamples_aligned.fa
#See information of mafft under:
#Note: https://mafft.cbrc.jp/alignment/software/anysymbol.html
#Note: https://www.ebi.ac.uk/jdispatcher/msa/mafft?stype=dna
#Note: I used --anysymbol to make sure that unusual characters such as U, #, . are scored as unknown
#For consistency, the script is below:

########################## Start mafft.sh script ####################
#!/bin/bash -l
#SBATCH -J Align_mtDNA
#SBATCH -o /scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/07.VCF_mtDNA/Align_mtDNA.out
#SBATCH -e /scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/07.VCF_mtDNA/Align_mtDNA.err
#SBATCH --account=project_2009316
#SBATCH -t 00:00:30
#SBATCH -p small
#SBATCH --ntasks 1
#SBATCH --mem=4G
#SBATCH --mail-type=BEGIN,END,FAIL

module load biokit

#First, we re-name the first line in each file
while IFS= read -r file; do
    # Extract the filename (without path if there's a directory)
    filename=$(basename "$file")

    # Replace the first line with ">sampleName: filename"
    sed -i "1s/.*/>sampleName: $filename/" "$file"

    echo "Replaced first line of $file with >sampleName: $filename"
done < samples.txt


#Second, we cat all samples together
cat *.fa > all38_mtDNAsamples.fa

#Third, we use mafft to align the samples
mafft --anysymbol all38_mtDNAsamples.fa > all38_mtDNAsamples_aligned.fa

#End script


##############
#Now, we download the file locally to plot it in PopArt. PopArt needs a phylip format, while the data format is mafft.
scp krapfpat@puhti.csc.fi:/scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/07.VCF_mtDNA/mtDNA_fa/all38_mtDNAsamples_aligned.fa ./ 


##WORK IN PROGRESS BELOW
#So, we need to change the format manually using the perl script "Fasta2Phylip.pl" from https://indra.mullins.microbiol.washington.edu/perlscript/docs/Sequence.html
#After downloading the script (do not forget to "chmod +x script), we run the script locally under 
#Linux - Root - Genomic data - Fasta2Phylip
#The code is below:
Fasta2Phylip.pl all38_mtDNAsamples_aligned.fa all38_mtDNAsamples_aligned.phylip

#The file "all38_mtDNAsamples_aligned.phylip" is now in a phylip format
#https://scikit.bio/docs/latest/generated/skbio.io.format.phylip.html
#and can be used as it is, but the suffix needs to be changed from "phylip" to "nex" (For more details, check the tutorial: https://dcsoto.github.io/2024/09/30/haplotype-network
all257_samples_aligned.nex
#This can be done locally. You can also use PGDspider to transform it! Then, you can use it in PopArt.

#### PopArt ####
# In PopArt, you load the "nex" file. Then you create a "Median Joining spanning network" and after that 
you can choose an "Epsilon"-value. "Epsilon defines a threshold for allowing connections that aren't the shortest (most parsimonious) path between nodes (haplotypes). By setting a higher epsilon, you permit more connections, allowing the network to capture more complexity, especially when evolutionary relationships are unclear or reticulate (branching and reconnecting).-CHATGPT info". Use the median-joining network

##WORK in progress below
So, I created the data to created haplotype network in PopArt.
First, I copied the 466 phylip file "all257_samples_aligned_246_20241110.phylip" which was already aligned and excluded samples NOT found in Finland (ie to 179 samples) and called it "all257_to_179samples_aligned_20241218.phylip".
Then I created a "Trait" file called "all257_to_179samples_Traits_20241218.txt". In this, each sample name has a species name and a number if it belongs to one of the species or admixed sample, e.g. 0,1,0,0,0,0,0,0 means it belongs to F aqui
You thhn load both files into PopArt. First the phylip-alignment, then the trait file. Do NOT delete the alignment when loading the file.
Then run the minnimum and then the median spanning network








