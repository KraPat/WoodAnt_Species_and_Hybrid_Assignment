## In this script, we will create an "admixture" plot based an allele frequency similarities (using the softwre "admixture").
## First, we need to create an "admixture" folder under "scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/filt/"
## Second, we need to create bim, bed, fam, and log files, using the script "12a_prep-f-admixture".
## Third, we run the "12b_admixture.sh" scipt to create the admixture plot.

################    Preperation for adxmiture analysis    ##################################
######## Beginning script called "12a_prep-f-admixture"
## It creates the blink bim, bed, fam, log files
## Note, we will use sinteractive for this and use the "mac2_thin20kb.vcf.gz". We have already created this file in the step 10_VCF_filtering. Below, for consistency. 
## In case we have an unbalanced sample design, we may want to balance this. Then, we need to select the samples we want to keep and store this information in a file called "balanced_sample_list.list". Here, our sample desing is quite balanced, so no need for this. It is added for consistency below.
##

sinteractive --account project_2009316 --mem 2000
module load biokit
module load plink

#VCF=/scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/06.VCF/filt/all_samples_DP8.AN10.noScaff0003.mac2.thin20kb.vcf.gz
OUTVCF=/scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/06.VCF/filt/all_samples_DP8.AN10.noScaff0003.mac2.thin20kb.vcf.gz
OUTPATH=/scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/06.VCF/admixture
OUTFILE=all_samples_DP8.AN10.noScaff0003.mac2_thin20kb

## Thin the VCF with 20kb distances to reduce linkage
#vcftools --gzvcf $VCF --thin 20000 --recode --stdout | bgzip > $OUTVCF
#bcftools index -t $OUTVCF
#bcftools index -n $OUTVCF #9927 SNPs

## Convert the VCF ("OUTVCF") into PLINK format for ADMIXTURE analysis
plink2 --threads 1 --vcf $OUTVCF --make-bed --double-id --allow-extra-chr --set-missing-var-ids @:# --out $OUTPATH/$OUTFILE

## Same code as above but WITH BALANCED SAMPLE LIST
## Convert the VCF ("OUTVCF") into PLINK format for ADMIXTURE analysis and keep only the desired individuals ("LIST" that is read in)
##LIST=balanced_sample_list.list
plink2 --threads 1 --vcf $OUTVCF --make-bed --double-id --allow-extra-chr --set-missing-var-ids @:# --keep $OUTPATH/$LIST --out $OUTPATH/$OUTFILE

## ADMIXTURE software doesn't accept non-human chromosome names. Replace the first column by 0.
cd admixture
awk '{$1=0;print $0}' all_samples_DP8.AN10.noScaff0003.mac2_thin20kb.bim >all_samples_DP8.AN10.noScaff0003.mac2_thin20kb.bim.tmp
mv all_samples_DP8.AN10.noScaff0003.mac2_thin20kb.bim.tmp all_samples_DP8.AN10.noScaff0003.mac2_thin20kb.bim.bim
## IMPORTANT: for the subsequent analysis, we have to use the "bim.bim" file, but we want to keep the original bim file as well. So, you have to rename (mv) the original file to "bim_ORIG" and the "bim.bim" file to only "bim"


############## Admixture script 12b_admixture.sh ######
## Now, we run sbatch 12b_admixture.sh inside the admixture folder, where the bed files are stored.
#Here, for each K, the P and Q files are created as well as the log files.

## START SCRIPT
#!/bin/bash -l
#SBATCH -J admixture
#SBATCH -o /scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/06.VCF/logs/admixture.out
#SBATCH -e /scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/06.VCF/logs/admixture.err
#SBATCH --account=project_2009316
#SBATCH -t 00:30:00
#SBATCH -p small
#SBATCH --ntasks 1
#SBATCH --mem=8G
#SBATCH --mail-type=BEGIN,END,FAIL

# Load modules
module load biokit
module load admixture 
## Note, we use the admixture module here

cd /scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/06.VCF/admixture

OUTPATH=/scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/06.VCF/admixture
FILE=all_samples_DP8.AN10.noScaff0003.mac2_thin20kb

for i in {1..10}
do
admixture --cv $OUTPATH/$FILE.bed $i > log${i}.out

done

grep "CV" *out | awk '{print $3,$4}' | cut -c 4,7-20 > $FILE.cv.error

### END SCRIPT

## Note, in the "...cv.error" file, the error rates are stored. The "K" value with the lowest error rates is the best number of populations based in the error rate. Here, it is "3" pops.

##### Now, we want to create an admixture plot. 
## Before creating the PDF or TIFF of the admixture plot is possible, we need to create a "plotting list". This is a list which includes the species ID, so that they are plotted together. Initially, this may not informative as we may not yet know what sample is what species. So we can simply use the "ID" of the sample, eg. "BE...". However, later on, when we are more confident about the species identity/assignment, we can use species ID alongside sample ID.
## To do this, we need to download the fam files as well as the P and Q files.
scp krapfpat@puhti.csc.fi:/scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/06.VCF/admixture/* ./ 
## with the code above, we download all files at aonce!
# OR
scp krapfpat@puhti.csc.fi:/scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/06.VCF/admixture/*P ./
# AND
scp krapfpat@puhti.csc.fi:/scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/06.VCF/admixture/*Q ./
# AND
scp krapfpat@puhti.csc.fi:/scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/06.VCF/admixture/all_samples_DP8.AN10.noScaff0003.mac2_thin20kb.fam ./
#ALL now under 
C:\Users\...

## Now, in R, under "HWE.filtering.R", we need the ".fam" file as well as the "eigenvector" file (may be an Excel file) created for the PCA beforehand. 
## For this, copy the Excel file "all_samples_DP8_PCA.xlsx" to the same folder and run the R code
## ADD INFO HERE
#WORKIN PROGRESS ####


Then, upload the file:
#Upload the plottign list file to PUHTI
scp ./Genomicdata/Samples257_DP8.246inds.AN10.noScaff00-03.mac2.thin20kb.plink.plotting.list krapfpat@puhti.csc.fi:/scratch/project_2009316/project_2009316/DutchSamples/X204SC23115958-Z01-F008/filt/admixture/Samples257_DP8.246inds.AN10.noScaff00-03.mac2.thin20kb.plink.plotting.list

Now, run R script interactively on Puhti:
sinteractive -A project_2009316 -c 1 -d 4 -m 1000 -t 00:30:00
module load r-env

#NOTE: ADMFILE is the prefix, before the P and Q of the files
ADMFILE=Samples257_DP8.246inds.AN10.noScaff00-03.mac2.thin20kb.plink
ADMLIST=Samples257_DP8.246inds.AN10.noScaff00-03.mac2.thin20kb.plink.plotting.list

Rscript "./plotADMIXTURE_K.R" -p $ADMFILE -i $ADMLIST -m 2 -k 9 -l prat,rufa,poly,aqui,lug,admixed1,admixed2,NA -o ${ADMFILE}
#Note: -l is the species names in the plotting list file

Download data
scp krapfpat@puhti.csc.fi:/scratch/project_2009316/DutchSamples/X204SC23115958-Z01-F008/filt/results/admixture/*pdf ./

Rscript "./plotADMIXTURE_Ina.R" -p $ADMFILE -i $ADMLIST -m 2 -k 6 -l prat,rufa,poly,aqui,lug,admixed1,admixed2,NA -o ${ADMFILE}

K 2-10
Rscript "./plotADMIXTURE_Ina.R" -p $ADMFILE -i $ADMLIST -m 2 -k 10 -l prat,rufa,poly,aqui,lug,admixed1,admixed2,NA -o ${ADMFILE}

or with 10kb
ADMFILE=Samples257_DP8.246inds.AN10.noScaff00-03.mac2.thin10kb.plink
ADMLIST=Samples257_DP8.246inds.AN10.noScaff00-03.mac2.thin10kb.plink.plotting.list

#####
RE-DO ADMIXTURE RUN WITH A REDUCED SAMPLE SIZE TO CREATE BALANCED APPROACH
using 10 inds
